<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<!--<link rel="shortcut icon" href="">-->
	<title>Dungeon shooter</title>
</head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>

<body>
	<script type="text/javascript">

		//ALIASES
		var Container = PIXI.Container,
			autoDetectRenderer = PIXI.autoDetectRenderer,
			loader = PIXI.loader,
			resources = PIXI.loader.resources,
			Sprite = PIXI.Sprite,
			TextureCache = PIXI.utils.TextureCache,
			pContainer = new PIXI.particles.ParticleContainer();

		var mousePos = {x: 0, y: 0};

		var renderer = autoDetectRenderer(
			256, 256,
			{
				antialias: false,
				transparent: false,
				resolution: 1
			});
		//renderer.view.style.position = "absolute";
		//renderer.view.style.display = "block";



		//renderer.view.style.border = "1px dashed black";
		document.body.appendChild(renderer.view);
		var stage = new Container();
		renderer.render(stage);


		loader.add("images/treasureHunter.json")
			.on("progress", loadProgressHandler)
			.load(setup);

		var dungeon, explorer, treasure, door, id;
		var missiles = [];
		var state;

		function setup(){
			//var cat = new Sprite(
			//	resources["images/cat.png"].texture
			//);
			dungeon = new Sprite(TextureCache["dungeon.png"]);
			stage.addChild(dungeon);
			explorer = new Sprite(TextureCache["explorer.png"]);
			stage.addChild(explorer);
			treasure = new Sprite(TextureCache["treasure.png"]);
			stage.addChild(treasure);
			door = new Sprite(TextureCache["door.png"]);
			stage.addChild(door);

			door.position.set(32, 0);

			explorer.x = 68;
			explorer.y = stage.height / 2 - explorer.height / 2;
			explorer.vx = 0;
			explorer.vy = 0;
			treasure.x = stage.width - treasure.width - 48;
			treasure.y = stage.height / 2 - treasure.height / 2;

			var numberOfBlobs = 6,
				spacing = 48,
				xOffset = 150;

			for(var i = 0; i < numberOfBlobs; i++){
				var blob = new Sprite(TextureCache["blob.png"]);

				// Spacing between blobs, xOffset from left screen border
				var x = spacing * i + xOffset;

				var y = randomInt(0, stage.height - blob.height);

				blob.position.set(x, y);
				stage.addChild(blob);
			}

			state = play;
			renderer.resize(stage.width, stage.height);
			renderer.render(stage);
			setupKeyHandler();
			setupMouseHandler()
			gameLoop();
		}




		function gameLoop(){
			requestAnimationFrame(gameLoop);

			state();
			this.renderer.render(this.stage);

		}

		function play(){

			moveExplorer();
			if(typeof missiles !== 'undefined' && missiles.length !== 0 ){
				missiles.forEach(function(missile){
					missile.x += missile.vx;
					missile.y += missile.vy;
				});
			}

		}

		function moveExplorer(){
			var atBorder = contain(explorer, {x: 28, y: 10, width: 488, height: 480});
			if(atBorder !== undefined){
				switch(atBorder){
					case "left" || "right":
						explorer.vx = 0;
						break;
					case "top" || "bottom":
						explorer.vy = 0;
						break;
					default :
						break;
				}
			}
			explorer.x += explorer.vx;
			explorer.y += explorer.vy;
		}

		function setupMouseHandler(){
			document.onmousemove = function(event){
				var rect = renderer.view.getBoundingClientRect();
				mousePos.x = event.clientX - rect.left;
				mousePos.y = event.clientY - rect.top;

			}
			document.onmousedown = function(event){
				var circle = new PIXI.Graphics();
				circle.beginFill(0x000000);
				circle.drawCircle(0,0,5);
				circle.endFill();
				// var bullet = new Sprite(TextureCache["treasure.png"]);
				missileLauncher(explorer, mousePos, circle, 4);
			}
		}

		function setupKeyHandler(){
			var left = keyboard(65);
			var right = keyboard(68);
			var up = keyboard(87);
			var down = keyboard(83);
			var space = keyboard(32);
			space.press = function(){

			}
			space.release = function(){
			}
			left.press = function(){

				explorer.vx = -1;

			}
			left.release = function(){
				if(!right.isDown && explorer.vy === 0){
					explorer.vx = 0;
				}
				//OVERRIDE
				explorer.vx = 0;
			}
			right.press = function(){
				explorer.vx = 1;
			}
			right.release = function(){
				if(!left.isDown && explorer.vy === 0){
					explorer.vx = 0;
				}
				explorer.vx = 0;
			}
			up.press = function(){
				explorer.vy = -1;
			}
			up.release = function(){
				if(!down.isDown && explorer.vy === 0){
					explorer.vy = 0;
				}
				explorer.vy = 0;
			}
			down.press = function(){
				explorer.vy = 1;
			}
			down.release = function(){
				if(!up.isDown && explorer.vy === 0){
					explorer.vy = 0;
				}
				explorer.vy = 0;
			}
		}
		/*
		shooter - shooter object that has the attributes x and y i.e. shooter.x and shooter.y
		target - target object that has the attributes x and y i.e. target.x and target.y
		missileSprite - object that can be added to stage which should represent the missile
						that is being shot, need x and y attributes
		missileSpeed - the speed that the missile moves at

		Example: shooter can be your character and the target can be your mouse position. Shooting
				 a bullet(missileSprite) with a certain speed(missileSpeed) from a gun.
		*/
		function missileLauncher(shooter, target, missileSprite, missileSpeed){
			var bullet = missileSprite;
			var bDx, bDy, vx, vy;
			var bulletSpeed = missileSpeed;
			var shooterCenterX = shooter.x + (shooter.width/2);
			var shooterCenterY = shooter.y + (shooter.height/2);
			
			bDx = target.x - shooterCenterX;
			bDy = target.y - shooterCenterY;
			bullet.rotation = Math.atan2(bDy, bDx);
			
			bullet.vx = Math.cos(bullet.rotation)*bulletSpeed;
			bullet.vy = Math.sin(bullet.rotation)*bulletSpeed;
			bullet.x = shooterCenterX;
			bullet.y = shooterCenterY;

			missiles.push(bullet);
			stage.addChild(bullet);
		}

		function contain(sprite, container) {

			var collision = undefined;

			//Left
			if (sprite.x < container.x) {
				sprite.x = container.x;
				collision = "left";
			}

			//Top
			if (sprite.y < container.y) {
				sprite.y = container.y;
				collision = "top";
			}

			//Right
			if (sprite.x + sprite.width > container.width) {
				sprite.x = container.width - sprite.width;
				collision = "right";
			}

			//Bottom
			if (sprite.y + sprite.height > container.height) {
				sprite.y = container.height - sprite.height;
				collision = "bottom";
			}

			//Return the `collision` value
			return collision;
		}


		function transformSprite(particleSprite, particle){
			particleSprite.position.x = particle.p.x;
			particleSprite.position.y = particle.p.y;
		}

		function keyboard(keyCode){
			var key = {};
			key.code = keyCode;
			key.isDown = false;
			key.isUp = true;
			key.press = undefined;
			key.release = undefined;

			key.downHandler = function(event) {
				if(event.keyCode === key.code){
					if(key.isUp && key.press) key.press();
					key.isDown = true;
					key.isUp = false;
				}
				event.preventDefault();
			};

			key.upHandler = function(event) {
				if(event.keyCode === key.code){
					if(key.isDown && key.release) key.release();
					key.isDown = false;
					key.isUp = true;
				}
				event.preventDefault();
			};

			window.addEventListener(
				"keydown", key.downHandler.bind(key), false
			);

			window.addEventListener(
				"keyup", key.upHandler.bind(key), false
			);
			return key;
		}

		function loadProgressHandler(loader, resource){
			console.log("loading: ", + resource.url);
			console.log("progress: ", + loader.progress + "%");
		}

		function randomInt(min, max){
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

	</script>
</body>
</html>
